# Authentification - Validation server action

### ğŸ’¡ Comprendre et mettre en place une authentification

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Pour mettre en place une authentification (rÃ©pondant Ã  la question "QUI se connecte"), il existe plusieurs maniÃ¨res :

### Auth/OpenID Connect (OIDC) :

Permettre l'accÃ¨s Ã  des tiers sans partager les identifiants des utilisateurs. IdÃ©al pour les connexions via les rÃ©seaux sociaux et les solutions de `Single Sign-On` (SSO). Ils ajoutent une couche d'identitÃ© avec `OpenID Connect`.

### Passkeys/WebAuthn :

Utilise des identifiants cryptographiques uniques pour chaque site, offrant une grande sÃ©curitÃ© contre le `phishing`. SÃ©curisÃ© mais nouveau, cette stratÃ©gie peut Ãªtre difficile Ã  mettre en Å“uvre.

### Authentification sans mot de passe / par jeton :

Utilise des liens magiques par email ou des codes uniques envoyÃ©s par SMS pour un accÃ¨s sÃ©curisÃ© sans mot de passe. Populaire pour sa commoditÃ© et sa sÃ©curitÃ© renforcÃ©e, cette mÃ©thode aide Ã  rÃ©duire la fatigue des mots de passe. Sa limitation est la dÃ©pendance Ã  la disponibilitÃ© de l'email ou du tÃ©lÃ©phone de l'utilisateur.

### Authentification par identifiants (Email + Mot de passe) :

Un choix standard pour les applications web, oÃ¹ les utilisateurs se connectent avec un email et un mot de passe. Familier et facile Ã  mettre en Å“uvre, cela nÃ©cessite des mesures de sÃ©curitÃ© robustes contre les menaces telles que le `phishing`.

Dans notre cas, nous allons utiliser cette derniÃ¨re.

Pour cela, il est nÃ©cessaire de disposer d'une base de donnÃ©es utilisateurs contenant des couples d'identifiants et de mots de passe (`credentials`). Cet identifiant peut Ãªtre un `email`, un `nom d'utilisateur`, ou les deux.

- Les utilisateurs doivent pouvoir crÃ©er un compte (`register`)
- Les utilisateurs doivent pouvoir se connecter (`login`), câ€™est Ã  dire vÃ©rifier le couple email/mot de passe

Avec cette information (qui est connectÃ©), nous pourrons dÃ©cider de quelles ressources du site sont autorisÃ©es ou pas.

Dans le cas dâ€™application `Next` ce fonctionnement peut Ãªtre dÃ©coupÃ© de la maniÃ¨re suivante :

- `FORM` : Formulaires contenant les champs Ã  transmettre au backend (`action`)
- `ACTION` : Valide le formulaire et appelle la librairie dâ€™authentification
- `AUTH LIB` : Librairie contenant la logique / norme / dâ€™authentification
- `DATABASE` : Persistance de donnÃ©es

![form-action-lib-db.png](/course/form-action-lib-db.png)

## Exercice

Nous allons, dans un premier temps connecter les formulaires aux actions.

Les formulaires / actions permettront de :

1. Valider les champs et afficher des Ã©ventuelles erreurs sur les champs.
2. Si la validation est OK, appelle de la librairie dâ€™authentification
3. Gestion des erreurs liÃ©es Ã  la librairie dâ€™authentification

Le type de retour des actions permet de gÃ©rer les messages dâ€™erreurs sur les champs ou un message dâ€™erreur plus gÃ©nÃ©ral (auth par exemple)

```tsx
export type FormState =
  | {
      errors?: {
        email?: string[]
        password?: string[]
        confirmPassword?: string[]
      }
      message?: string
    }
  | undefined
```

- Auth Librairie

Pour le moment, cette librairie est `mockÃ©e`, nous lâ€™implÃ©menterons plus tard.

```tsx
const signUp = async (email: string, password: string) => {
  await new Promise((resolve) => setTimeout(resolve, 1000))
  console.log('Signing up...', email, password)
  return {email, role: RoleEnum.USER}
  //
  // âš ï¸ en cas d'erreur de signup on peut lancer une erreur de type SignInError
  // throw {
  //   type: 'CredentialsSignin',
  //   message: 'Invalid User.',
  // } as SignInError
}

const signIn = async (email: string, password: string) => {
  await new Promise((resolve) => setTimeout(resolve, 1000))
  console.log('signIn ...', email, password)
  return {email, role: RoleEnum.USER}
}

async function logout() {
  await new Promise((resolve) => setTimeout(resolve, 1000))
  return {message: 'Logout successful'}
}
```

Type dâ€™erreur levÃ© par la librairie dâ€™auth

```tsx
export interface SignInError {
  type: 'CredentialsSignin'
  message?: string
}
//exemple
throw {
  type: 'CredentialsSignin',
  message: 'Invalid User.',
} as SignInError
```

Ps : Les schÃ©mas `Zod` sont dÃ©jÃ  fournis dans `/auth/lib/type.ts`

```tsx
export const LoginFormSchema = z.object({
  email: z.string().email({message: 'Please enter a valid email.'}),
  password: z.string().min(1, {message: 'Password field must not be empty.'}),
})
//etc ...
```

ğŸ¶ Dans cet exercice, tu vas devoir :

- ImplÃ©menter les 2 formulaires (`login/register`) en utilisant le hook `useActionState`
- GÃ©rer le `status pending` (`useFormState`)
- Valider les champs avec `Zod`
- GÃ©rer les messages dâ€™erreurs
- Faire appel Ã  la librairie dâ€™authentification

Fichiers

- `exercise/auth/action.tsx`
- `exercise/auth/form/form-login.tsx`
- `exercise/auth/form/form-register.tsx`

## Bonus

### 1. ğŸš€ Gestion status pending via state (logout)

Pour le `logout` nous avons juste Ã  appeler une fonction `logout` `await logout()`. Nous nâ€™avons pas de formulaire ni de champs Ã  valider.

Nous appelons directement une action. Nous nâ€™avons pas accÃ¨s Ã  `useFormStatus`.

Pour cela, nous allons gÃ©rer le statut avec un simple `state`. Le principe est dâ€™attendre le retour du serveur action `logout`

```tsx
setPending(true)
await logout()
setPending(false)
```

- **ğŸ¶** ImplÃ©mente cela pour le logout

Fichiers

- `exercise/auth/form/form-logout.tsx`

## Aller plus loin

ğŸ“‘ Le lien vers la doc `useActionState` [https://react.dev/reference/react/useActionState](https://react.dev/reference/react/useActionState)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=05.Next%20Auth&entry.533578441=02%20Authentification%20-%20Validation%20Form).
