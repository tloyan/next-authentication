# Next Middleware

### ğŸ’¡ Comprendre Next Middleware

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Les middlewares dans `Next.js` **permettent d'exÃ©cuter du code avant qu'une requÃªte ne soit complÃ©tÃ©e**. GrÃ¢ce aux `middlewares`, vous pouvez modifier la rÃ©ponse en rÃ©Ã©crivant, redirigeant, modifiant les en-tÃªtes de requÃªte ou de rÃ©ponse, ou en rÃ©pondant directement en fonction de la requÃªte entrante.

Les middlewares s'exÃ©cutent avant que le contenu mis en cache et les routes ne soient appariÃ©s.

### Cas d'Utilisation des Middlewares

IntÃ©grer des middlewares dans votre application peut entraÃ®ner des amÃ©liorations significatives en termes de performances, de sÃ©curitÃ© et d'expÃ©rience utilisateur. Voici quelques scÃ©narios courants oÃ¹ les middlewares sont particuliÃ¨rement efficaces :

- **Authentification et Autorisation** : VÃ©rifiez l'identitÃ© de l'utilisateur et contrÃ´lez les cookies de session avant de lui accorder l'accÃ¨s Ã  des pages ou des routes `API` spÃ©cifiques.
- **Redirections Serveur** : Redirigez les utilisateurs au niveau du serveur en fonction de certaines conditions (par exemple, la langue, le rÃ´le de l'utilisateur).
- **RÃ©Ã©criture de Chemins** : Prenez en charge les tests `A/B`, les dÃ©ploiements de fonctionnalitÃ©s ou les chemins d'accÃ¨s hÃ©ritÃ©s en rÃ©Ã©crivant dynamiquement les chemins vers des routes `API` ou des pages en fonction des propriÃ©tÃ©s de la requÃªte.
- **DÃ©tection de Bots** : ProtÃ©gez vos ressources en dÃ©tectant et en bloquant le trafic des bots.
- **Journalisation et Analyse** : Capturez et analysez les donnÃ©es de la requÃªte pour obtenir des informations avant le traitement par la page ou l'`API`.
- **Gestion de FonctionnalitÃ©s** : Activez ou dÃ©sactivez des fonctionnalitÃ©s de maniÃ¨re dynamique pour des dÃ©ploiements de fonctionnalitÃ©s ou des tests en douceur.

### ScÃ©narios Ã  Ã‰viter avec les Middlewares

Il est Ã©galement important de reconnaÃ®tre les situations oÃ¹ les middlewares ne sont pas la solution optimale :

- **RÃ©cupÃ©ration et Manipulation Complexe de DonnÃ©es** : Les middlewares ne sont pas conÃ§us pour la rÃ©cupÃ©ration directe ou la manipulation des donnÃ©es, cela doit Ãªtre fait au sein des gestionnaires de routes ou des utilitaires cÃ´tÃ© serveur.
- **TÃ¢ches Computationnelles Lourdes** : Les middlewares doivent Ãªtre lÃ©gers et rÃ©pondre rapidement. Les tÃ¢ches computationnelles lourdes ou les processus de longue durÃ©e doivent Ãªtre effectuÃ©s dans des gestionnaires de routes dÃ©diÃ©s.
- **Gestion Extensive de Sessions** : Bien que les middlewares puissent gÃ©rer des tÃ¢ches de session basiques, la gestion extensive de sessions doit Ãªtre confiÃ©e Ã  des services d'authentification dÃ©diÃ©s ou aux gestionnaires de routes.
- **OpÃ©rations Directes sur la Base de DonnÃ©es** : Les opÃ©rations directes sur la base de donnÃ©es dans les middlewares ne sont pas recommandÃ©es. Les interactions avec la base de donnÃ©es doivent Ãªtre effectuÃ©es dans les gestionnaires de routes ou les utilitaires cÃ´tÃ© serveur.

Un exemple simple est par exemple de dire

- Si une requÃªte est faite sur `â€˜/â€™` on redirige vers `â€˜/exercisesâ€™`

```tsx
//src/middleware.ts
import {NextResponse, type NextRequest} from 'next/server'

export async function middleware(request: NextRequest) {
  const path = request.nextUrl.pathname
  if (path === '/') {
    return NextResponse.redirect(new URL('/exercises', request.url))
  }
  return NextResponse.next()
}
```

ğŸ“‘ Le lien vers la doc [https://nextjs.org/docs/app/building-your-application/routing/middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware)

## Exercice

Dans les exercices prÃ©cÃ©dents, nous avons utilisÃ© un `HOC withAuth` pour protÃ©ger nos routes. Nous avons ici une autre mÃ©thode, le `middleware next`. Pour les besoins de lâ€™exercice, nous avons supprimÃ© `withAuth` des routes protÃ©gÃ©es (`dashboard` / `bank-account` etcâ€¦).

- Elles ne sont donc plus protÃ©gÃ©es.

**ğŸ¶ Dans cet exercice, tu vas devoir implÃ©menter un middleware pour protÃ©ger les routes privÃ©es.**

Le principe va Ãªtre de :

- Analyser la route demandÃ©e (publique ou privÃ©e).
- DÃ©crypter le cookie.
- VÃ©rifier la prÃ©sence ou non de `sessionId` ou `userId`
- Rediriger en consÃ©quence.
  - Route privÃ©e
    - Pas de session â†’ redirection `/login`
    - Si session â†’ on laisse passer
  - Route publique
    - Pas de session â†’ on laisse passer
    - Si session â†’ redirection `/auth`

Fichiers

- `src/middleware.ts`

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://nextjs.org/docs/app/building-your-application/routing/redirecting#nextresponseredirect-in-middleware](https://nextjs.org/docs/app/building-your-application/routing/redirecting#nextresponseredirect-in-middleware)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=05.Next%20Auth&entry.533578441=10%20MiddleWare).
