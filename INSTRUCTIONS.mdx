# Librairie Next-Auth

### ğŸ’¡ Utiliser NextAuth (AuthJS)

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans les modules prÃ©cÃ©dents, nous avons crÃ©Ã© notre propre systÃ¨me d'authentification par `credentials` ainsi que la gestion des sessions. Cependant, il est parfois nÃ©cessaire d'utiliser un ou plusieurs systÃ¨mes d'authentifications tiers, qu'ils soient privÃ©s ou publiques.

Par exemple, nous pourrions avoir besoin de permettre la connexion via `Google`, `Facebook`, `Github` ou n'importe quel autre fournisseur. Pour cela, il existe une librairie appelÃ©e `Next Auth`, rÃ©cemment renommÃ©e [`AuthJS`](https://authjs.dev/getting-started/installation?framework=next.js). Son objectif est d'abstraire la gestion des sessions et de simplifier l'intÃ©gration avec d'autres systÃ¨mes d'authentification.

## Installation :

Les 3 fichiers principaux :

### `auth.ts`

Le fichier principal contenant toute la configuration, providers etcâ€¦

```tsx
//./auth.ts
import NextAuth from "next-auth"

export const { handlers, signIn, signOut, auth } = NextAuth({
  providers: [],
})
```

### `route.ts`

La route de callback

```tsx
//./app/api/auth/[...nextauth]/route.ts
import { handlers } from "@/auth" // Referring to the auth.ts we just created
export const { GET, POST } = handlers
```

### `middleware.ts`

Le middleware

```tsx
//./middleware.ts
export { auth as middleware } from "@/auth"
```

ğŸ“‘ Le lien vers la doc [https://fr.reactjs.org/docs/getting-started.html](https://fr.reactjs.org/docs/getting-started.html)

## Providers :

Il existe de nombreux providers comme `Google`, `Facebook`, etcâ€¦

Ils sont regroupÃ©s par types :

- Oauth
- Magic Link
- Credential
- WebAuthn

Pour ajouter un provider( exemple Google) :

```tsx

import NextAuth from "next-auth"
import Google from "next-auth/providers/google"

export const { handlers, signIn, signOut, auth } = NextAuth({
  providers: [Google],
})

```

Et ensuite :

```tsx
import { signIn } from "@/auth"

export function SignIn() {
  return (
    <form
      action={async () => {
        "use server"
        await signIn("google")
      }}
    >
      <button type="submit">Signin with Google</button>
    </form>
  )
}
```

Doc : https://authjs.dev/getting-started/authentication/oauth

## Exercice

Dans cet exercice, tu vas devoir dÃ©commissionner lâ€™ancien mode de fonctionnement et utiliser `Next-Auth`

<aside>
ğŸ’¡ 
Les middlewares de `Next.js` et `NextAuth` fonctionnent avec le runtime `Edge`, optimisÃ©s pour des rÃ©ponses rapides. Ils n'incluent pas l**'intÃ©gralitÃ© des API Node.js**, notamment `fs` (systÃ¨me de fichiers). Cela permet une exÃ©cution plus lÃ©gÃ¨re et sÃ©curisÃ©e en environnement `Edge`.

</aside>

Runtime check

```tsx
console.log('process.env.NEXT_RUNTIME AUTH', process.env.NEXT_RUNTIME)
```

Pour les besoins de lâ€™exercice, nous avons changÃ© `lowDb` par `Unstorage` qui permet dâ€™avoir une DB compatible avec NextAuth

En production et pour des projets de plus grande ampleur, il faut utiliser une librairie de gestion de BDD compatible :

- [https://authjs.dev/getting-started/database](https://authjs.dev/getting-started/database)
- `bcrypt` a Ã©tÃ© remplacÃ© par `bcryptjs` mais le fonctionnement reste le mÃªme.

Pour simplifier lâ€™exercice, voilÃ  lâ€™ensemble du dÃ©commissionnement.

### DÃ©commissionnement :

- `@/db/sgbd`
  - RemplacÃ© par `@/db/sgbd-unstorage`
- `@/app/exercises/auth/lib/auth`
  - `Next-Auth`
- `@/app/exercises/auth/session`
  - `Next-Auth`

### Adaptation

- `bcrypt`
  - RemplacÃ© par `bcryptjs`
- dal (`verifySession`)
  - `Next-Auth`
- action (`import {auth} from '@/app/exercises/auth/lib/auth`)
  - `Next-Auth`

Tu retrouveras Ã©galement des formulaires dÃ©jÃ  connectÃ©s :

```tsx
 <div className="mx-auto max-w-2xl p-6  text-lg ">
      {/* <LoginForm></LoginForm> */}
      <h1 className="mb-4 text-center text-3xl font-bold">Google</h1>
      <SignInGoogle></SignInGoogle>
      <h1 className="mb-4 text-center text-3xl font-bold">Credentials</h1>
      <SignInCredential />
      <h1 className="mb-4 text-center text-3xl font-bold">Resend</h1>
      <SignInResend />
    </div>
```

Pour [Google](https://developers.google.com/identity/protocols/oauth2?hl=fr) autre provider, cela requiert des clÃ©s `API` Ã  crÃ©er sur `Google Cloud` ou sur [Github](https://authjs.dev/guides/configuring-github)

Nous allons ici nous concentrer sur le `credentials` `<SignInCredential />`

Dans la documentation, nous avons un appel Ã  `singIn` :

```tsx
import { signIn } from "@/auth"

export function SignIn() {
  return (
    <form
      action={async (formData) => {
        "use server"
        await signIn("credentials", formData)
      }}
    >
      <label>
        Email
        <input name="email" type="email" />
      </label>
      <label>
        Password
        <input name="password" type="password" />
      </label>
      <button>Sign In</button>
    </form>
  )
}
```

Dans notre cas, nous appellerons dâ€™abord le `server action` avec le hook `useActionstate` ce qui nous permettra de gÃ©rer les erreurs et le `formStatus`

```tsx
const [actionState, authenticateAction] = useActionState(authenticate, {})
```

- **ğŸ¶ Dans un premier temps, tu vas dÃ©commissionner lâ€™appel Ã  notre lib `auth.ts` perso dans la fonction `authenticate` et utilise `signIn` de `nextAuth` Ã  la place**
- **ğŸ¶** DÃ©place la logique de validation `user/mdp` dans le fichier `auth.ts` de `nextAuth`

Fichiers

- `/auth.ts`
- `/app/exercices/auth/action.ts`

## Bonus

### 1. ğŸš€ Register

Adapte la fonction `register` de lâ€™action. Le but Ã©tant de sâ€™inscrire et de gÃ©nÃ©rer une session pour Ãªtre directement connectÃ©.

Fichiers

- `/app/exercices/auth/action.ts`

###

### 2. ğŸš€ Protected route avec MiddleWare

https://authjs.dev/getting-started/session-management/protecting

Mais il est possible de le faire dans `auth.ts` grÃ¢ce Ã  un callback `authorized` si le middleware est associÃ© a `nextauth`

<aside>
ğŸ’¡

Attention cela va switcher lâ€™authentification avec le nuntine EDGE

</aside>

```tsx
//middleware.ts
export {auth as middleware} from '@/auth'

```

```tsx
export const {handlers, signIn, signOut, auth} = NextAuth({
  callbacks: {
    authorized: async ({auth, request: {nextUrl}}) => {
    if (isProtectedRoute && !hasSession) {
        return Response.redirect(new URL('/exercises/login', nextUrl))
     }
  return true
    },
  },
```

Dans cet exercice, tu vas devoir implÃ©menter la mÃªme rÃ¨gle de protection des routes que prÃ©cÃ©demment : Rappel :

```tsx

// 1. Specify protected and public routes
const protectedRoutes = new Set([
  '/exercises/dashboard',
  '/exercises/bank-account',
])
const publicRoutes = new Set(['/'])

const adminRoutes = new Set(['/admin'])

const redactorRoutes = new Set(['/redaction'])

export async function middleware(request: NextRequest) {
  const path = request.nextUrl.pathname
  const isProtectedRoute = protectedRoutes.has(path)
  const isPublicRoute = publicRoutes.has(path)
  const isAdminRoute = adminRoutes.has(path)
  const isRedactorRoute = redactorRoutes.has(path)

  const cookie = cookies().get('session')?.value
  const session = await decrypt(cookie)

  const role = session?.role
  console.log('middleware role', role)

  const hasSession = session?.userId || session?.sessionId

  if (isProtectedRoute && !hasSession) {
    return NextResponse.redirect(new URL('/exercises/login', request.nextUrl))
  }
  //admin route
  if (
    isAdminRoute &&
    !role?.includes(RoleEnum.ADMIN) &&
    !role?.includes(RoleEnum.SUPER_ADMIN)
  ) {
    return NextResponse.redirect(new URL('/restricted/', request.nextUrl))
  }
  // Redactor route
  if (
    isRedactorRoute &&
    !role?.includes(RoleEnum.ADMIN) &&
    !role?.includes(RoleEnum.SUPER_ADMIN) &&
    !role?.includes(RoleEnum.REDACTOR) &&
    !role?.includes(RoleEnum.MODERATOR)
  ) {
    return NextResponse.redirect(new URL('/restricted/', request.nextUrl))
  }
  if (isPublicRoute && hasSession) {
    return NextResponse.redirect(new URL('/exercises/auth', request.nextUrl))
  }
  NextResponse.next()
}
```

- **ğŸ¶ RÃ©cupÃ¨re le RÃ”LE du user avec `getUserByEmail` et implÃ©mente les mÃªmes rÃ¨gles.**

Constate le problÃ¨me de runtime `edge` avec `unstorage.`

Cette solution nâ€™est donc compatible quâ€™avec des solutions compatibles `edge`

Pour simuler cela on va passer un une DB en memory pour lâ€™exercice

```tsx
//unstorage-store.ts
import memoryDriver from 'unstorage/drivers/memory' // Utilisation d'un driver en mÃ©moire pour l'exemple
const storage = createStorage({
  driver: memoryDriver(),
})

export default storage
```

Constate

Fichiers

- `auth.ts`
- `middleware.ts`

### 3. ğŸš€ Protected route (sans middleware)

Pour protÃ©ger les routes :

```tsx
import { auth } from "@/auth"

export default async function Page() {
  const session = await auth()
  if (!session) return <div>Not authenticated</div>

  return (
    <div>
      <pre>{JSON.stringify(session, null, 2)}</pre>
    </div>
  )
}
```

**ğŸ¶ ProtÃ¨ge les routes pour les user :**

- /exercises/dashboard
- /exercises/bank-account
- /exercises/bank-account

**ğŸ¶ ProtÃ¨ge les routes avec ROLES pour :**

- **/admin**
- /redaction

Fichiers

- `/exercises/dashboard.tsx`
- `/exercises/bank-account.tsx`
- `/admin/page.tsx`
- `/admin/page.tsx`
- `/redaction/page.tsx`

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://authjs.dev/getting-started/installation?framework=next.js](https://authjs.dev/getting-started/installation?framework=next.js)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=05.Next%20Auth&entry.533578441=13%20Next%20-%20Auth).
