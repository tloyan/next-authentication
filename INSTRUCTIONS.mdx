# Autorization (AuthZ) Server Action

### ğŸ’¡ ProtÃ©ger les server actions

## ğŸ“ Tes notes

Detaille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Nous avons vu prÃ©cÃ¨dent comment vÃ©rifier quâ€™un utilisateur est connectÃ© ou non pour autoriser lâ€™accÃ¨s Ã  des routes. Nous avons Ã©galement vu comment autoriser certaines routes en fonction du rÃ´le (RBAC)

Il est important Ã©galement de protÃ©ger les Server Actions (qui ne sont pas des routes). Un mÃ©thode simple consiste a vÃ©rifier que le user est `authentifier` (via la session par exemple)

```tsx
//action.ts
'use server';
export async function addItem(formData: FormData) {
  const {userId} = session();

  if (!userId) {
    throw new Error('You must be signed in to add an item to your cart');
  }

  console.log('add item server action', formData);
  }
```

Mais il est Ã©galement possible de protÃ©ger certaines fonctionnalitÃ© en fonction du `role`. Exemple

```tsx
//action.ts
'use server';
export async function addItem(formData: FormData) {
  const {role} = session();

  if (role !=== 'ADMIN') {
    throw new Error('You cannot delete this product listing');
  }
	deleteProduct(formData.get('id'))
  }
```

## Exercice

Dans cet exercice nous avons sur la page `exercices/auth` 2 nouveaux formulaires.

```tsx
//exercices/auth/page.tsx
<ChangeRoleForm />
<AdminChangeRoleForm />
```

2 formulaires qui permettent de :

- `ChangeRoleForm` : Changer le rÃ´le de lâ€™utilisateur connectÃ©
- `AdminChangeRoleForm` : Changer le rÃ´le de nâ€™importe quel user dans lâ€™application

Pour simplifier lâ€™exercice, ces formulaire sont fournis et connectÃ© au server actions.

Mais aucune rÃ¨gle nâ€™est prÃ©sente pour dÃ©terminer ce que lâ€™utilisateur peut faire.

**ğŸ‘¨â€âœˆï¸ Hugo le chef de projet te demande de gÃ©rer lâ€™autorisation des actions avec les rÃ¨gles suivantes :**

- **Les utilisateurs peuvent changer `LEURS` rÃ´les ( `changeConnectedUserRole` ) mais sans augmentation de privilÃ¨ges** Exemple:
  - Passer de `ADMIN` Ã  `REDACTOR` â†’ OK
  - Passer de `REDACTOR` Ã  `ADMIN` â†’ KO
- Les `ADMIN` et `SUPER_ADMIN` peuvent changer le rÃ´les de nâ€™importe quâ€™el user dans lâ€™application (`changeUserRole`)

Fichiers

- `exercise/auth/action.ts`

##

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://www.w3schools.com/html/html_css.asp](https://www.w3schools.com/html/html_css.asp)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=5.Next%20Auth&entry.533578441=12-authorization-server-action).
