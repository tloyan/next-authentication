# Middleware - AuthZ (Authorization)

### ğŸ’¡ ProtÃ©ger des routes avec de lâ€™autorisation

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans le monde de la sÃ©curitÃ© informatique, deux concepts fondamentaux jouent un rÃ´le crucial dans la protection des systÃ¨mes et des donnÃ©es : l'authentification (`AuthN`) et l'autorisation (`AuthZ`). Bien que souvent confondus, ces termes dÃ©signent des processus distincts mais complÃ©mentaires. Comprendre la diffÃ©rence entre l'authentification et l'autorisation est essentiel pour sÃ©curiser efficacement vos applications et services.

### **Authentification (AuthN)** :

L'authentification est le processus de vÃ©rification de l'identitÃ© d'un utilisateur. Elle rÃ©pond Ã  la question "Qui es-tu ?". Lorsqu'un utilisateur tente d'accÃ©der Ã  une application ou un service, il doit prouver son identitÃ©, gÃ©nÃ©ralement par des moyens tels qu'un nom d'utilisateur et un mot de passe, un jeton (`token`), ou d'autres formes de preuve d'identitÃ© comme des empreintes digitales ou des codes envoyÃ©s par `SMS`. Une fois l'identitÃ© vÃ©rifiÃ©e, l'utilisateur est authentifiÃ©.

Exemple :

- **Connexion Ã  un site web** : Lorsqu'un utilisateur entre son nom d'utilisateur et son mot de passe, le systÃ¨me vÃ©rifie que ces informations correspondent Ã  celles enregistrÃ©es dans la base de donnÃ©es. Si elles correspondent, l'utilisateur est authentifiÃ© et peut accÃ©der Ã  son compte.

### **Autorisation (AuthZ)** :

L'autorisation, en revanche, dÃ©termine les permissions et les niveaux d'accÃ¨s d'un utilisateur authentifiÃ©. Elle rÃ©pond Ã  la question "Que peux-tu faire ?". Une fois qu'un utilisateur est authentifiÃ©, le systÃ¨me doit vÃ©rifier quels privilÃ¨ges et accÃ¨s lui sont accordÃ©s. Cela peut inclure l'accÃ¨s Ã  certaines ressources, la capacitÃ© Ã  exÃ©cuter des actions spÃ©cifiques ou des niveaux de permissions particuliers.

Exemple :

- **AccÃ¨s aux fonctionnalitÃ©s** : AprÃ¨s s'Ãªtre connectÃ©, un utilisateur avec le rÃ´le `"Admin"` peut avoir accÃ¨s Ã  des fonctionnalitÃ©s d'administration comme la gestion des utilisateurs et la modification des paramÃ¨tres du site, tandis qu'un utilisateur avec le rÃ´le `"Utilisateur"` n'aura accÃ¨s qu'Ã  ses propres donnÃ©es et fonctionnalitÃ©s limitÃ©es.

### Pourquoi ces distinctions sont-elles importantes ?

Dans toute application sÃ©curisÃ©e, il est crucial de mettre en Å“uvre Ã  la fois l'authentification et l'autorisation. L'authentification assure que les utilisateurs sont bien ceux qu'ils prÃ©tendent Ãªtre, tandis que l'autorisation garantit que ces utilisateurs n'accÃ¨dent qu'aux ressources et actions pour lesquelles ils sont autorisÃ©s. Ignorer l'une de ces Ã©tapes peut entraÃ®ner des failles de sÃ©curitÃ© importantes, comme l'accÃ¨s non autorisÃ© Ã  des donnÃ©es sensibles ou la prise de contrÃ´le de fonctionnalitÃ©s critiques.

### En rÃ©sumÃ©

- **Authentification (`AuthN`)** : VÃ©rifie l'identitÃ© de l'utilisateur.
- **Autorisation (`AuthZ`)** : DÃ©termine ce que l'utilisateur authentifiÃ© est autorisÃ© Ã  faire.

Jusque-lÃ , nous avons mis en place lâ€™authentification, nous allons maintenant faire de lâ€™autorisation avec un cas relativement basique. La protection de routes en fonction des rÃ´les. Jusque-lÃ , nous avions :

- Non authentifier â†’ routes publiques
- Authentifier â†’ routes protÃ©gÃ©es

Nous nâ€™avons pas assez de finesse pour gÃ©rer dâ€™autres types de routes, comme par exemple celles dâ€™un administrateur. Pour faire cela, nous allons introduire des `ROLES`

```tsx
export enum RoleEnum {
  USER = 'USER',
  GUEST = 'GUEST ',
  REDACTOR = 'REDACTOR',
  MODERATOR = 'MODERATOR ',
  ADMIN = 'ADMIN',
  SUPER_ADMIN = 'SUPER_ADMIN',
}
```

Il va falloir se baser sur ces rÃ´les pour gÃ©rer les accÃ¨s.

### AccÃ¨s Database dans le middleware ?

Dans le middleware, nous accÃ©dons Ã  la session stockÃ©e dans les cookies.

```tsx
const hasSession = session?.userId || session?.sessionId
```

On pourrait envisager de faire un appel Ã  cette fonction pour rÃ©cupÃ©rer le rÃ´le.

```tsx
const user = await getUserById(session?.userId)
user.role
```

**Mais cela nâ€™est pas une bonne approche !**

- Le middleware sâ€™exÃ©cute dans le runtime [EDGE](https://vercel.com/docs/functions/runtimes/edge-runtime) (qui nâ€™a pas accÃ¨s Ã  toutes les `API` de `Node`, comme par exemple `FS`). Il nous est donc impossible dâ€™appeler notre BDD.
- On pourrait utiliser dâ€™autres systÃ¨mes compatibles (`unstorage`, `drizzle`), mais il ne faut pas oublier que le `midleware` est exÃ©cutÃ© Ã  chaque requÃªte serveur. Faire des appels en BDD ralentirait considÃ©rablement le site.

**La solution ?**

- Mettre lâ€™information rÃ´le dans la session (cookie)
- Il sera peu coÃ»teux de rÃ©cupÃ©rer cette information dans le middleware

**Est-ce sÃ©curisÃ© ?**

- Un utilisateur malveillant pourrait envoyer une requÃªte en changeant le rÃ´le (`USER`â†’ `ADMIN`) dans la requÃªte `HTTP`.
- Pour Ã©viter cela, **IL EST IMPÃ‰RATIF dâ€™utiliser JWT. Avec** `JWT`, une requÃªte modifiÃ©e serait invalidÃ©e cÃ´tÃ© serveur.

## Exercice

**ğŸ‘¨â€âœˆï¸ Hugo, le chef de projet, te demande** dâ€™implÃ©menter un systÃ¨me dâ€™autorisation et dâ€™implÃ©menter les rÃ¨gles suivantes

- Si un utilisateur a le rÃ´le `ADMIN` ou `SUPER_AMDIN` : il peut accÃ©der Ã  tout plus : `/exercices/admin`
- Si un utilisateur a le rÃ´le `REDACTOR` ou `MODERATOR` : il peut accÃ©der Ã  tout plus : `/exercices/redaction` (sans `/exercices/admin`)

Pour simplifier lâ€™exercice, le `rÃ´le` a Ã©tÃ© ajoutÃ© dans la session, il sera donc accessible dans le middleware.

```tsx
//type.ts
export type SessionPayload = {
  userId?: string | number
  sessionId?: string
  expiresAt: Date
  role?: RoleEnum
}
//session.ts
const user = await getUserById(uid)
const session = await encrypt({
  sessionId: sessionByUid.sessionId,
  expiresAt,
  role: user?.role,
})
```

2 routes fictives ont Ã©tÃ© ajoutÃ©es.

- `/admin`
- `/redaction`

Ainsi quâ€™une route `/restricted` qui affiche un message de restriction.

**ğŸ¶ ImplÃ©mente les rÃ¨gles demandÃ©es par le chef de projet.**

PS : Ã‰dite le fichier `src/db/db.json` pour changer les rÃ´les.

Fichiers

- `src/middleware.ts`

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://nextjs.org/docs/app/building-your-application/routing/middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=05.Next%20Auth&entry.533578441=11%20Middleware%20-%20Authorization).
