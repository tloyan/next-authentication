# Session Management - Cookies

### ğŸ’¡ Comprendre les sessions `stateless`

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

La gestion de session implique le suivi et la gestion des interactions d'un utilisateur avec l'application au fil du temps, en veillant Ã  ce que son Ã©tat authentifiÃ© soit prÃ©servÃ© dans les diffÃ©rentes parties de l'application.

Cela Ã©vite la nÃ©cessitÃ© de se reconnecter Ã  plusieurs reprises, amÃ©liorant Ã  la fois la sÃ©curitÃ© et la commoditÃ© pour l'utilisateur.

Il existe deux mÃ©thodes principales pour la gestion des sessions :

- les **sessions basÃ©es sur les cookies** (`stateless session`).
- Et les sessions stockÃ©es en **base de donnÃ©es**. (`database session`).

Dans cette section, nous verrons les sessions simples basÃ©es sur les cookies.

### Principe :

- Lorsque lâ€™utilisateur est connectÃ© â†’ CrÃ©ation dâ€™un Cookie avec `userId` par exemple.
- Ce cookie est prÃ©sent dans le header des requÃªtes HTTP.
- La session est dÃ©codÃ©e / vÃ©rifiÃ©e pour extraire le `userId` cÃ´tÃ© le serveur.
- Il est ensuite possible dâ€™accÃ©der aux donnÃ©es utilisateurs (`userId`) et de gÃ©rer les accÃ¨s par exemple.

### Cookie server avec `Next`

```tsx
'use server'

import {cookies} from 'next/headers'

export async function handleLogin(sessionData) {
  const encryptedSessionData = encrypt(sessionData) // Encrypt your session data
  cookies().set('session', encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    maxAge: 60 * 60 * 24 * 7, // One week
    path: '/',
  })
  // Redirect or handle the response after setting the cookie
}
```

## Exercice

Dans cet exercice, tu vas devoir crÃ©er le mÃ©canisme de session gÃ©rÃ© par des cookies.

Pour simplifier lâ€™exercice, nous nâ€™allons pas encore encrypter le cookie, mais seulement manipuler du `JSON`

```tsx
//lib/crypt.ts
export async function encrypt(payload: SessionPayload) {
  return JSON.stringify(payload)
}

export async function decrypt(
  session: string | undefined = ''
): Promise<SessionPayload | undefined> {
  return JSON.parse(session)
}
```

ğŸ¶ Dans un premier temps, implÃ©mente les 3 fonctions suivantes :

- `createSession`
- `verifySession`
- `deleteSession`

**ğŸ¶** Dans **`auth.ts`** crÃ©e une session aprÃ¨s la crÃ©ation de compte ou la connexion et supprime le cookie sur le `logout`

Fichiers

- `exercise/auth/lib/session-stateless.ts`
- `exercise/auth/lib/auth.ts`

## Bonus

### 1. ğŸš€ Gestion de page avec information session utilisateur

Maintenant que nous savons crÃ©er des cookies de sessions, nous pouvons les utiliser dans nos pages pour rÃ©cupÃ©rer les informations utilisateur.

- Dans cet exercice, **ğŸ‘¨â€âœˆï¸ Hugo, le chef de projet,** te demande de modifier la route [/exercices/auth](http://localhost:3000/exercises/auth). Actuellement cette page affiche : **`You are not connected`.**
- Utilise `verifySession()` et `getUserById` pour afficher : `Hello {user.email}` si un utilisateur est connectÃ©.

Fichiers

- `exercise/auth/page.tsx`

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://nextjs.org/docs/app/building-your-application/authentication#authentication](https://nextjs.org/docs/app/building-your-application/authentication#authentication)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=05.Next%20Auth&entry.533578441=04%20Session%20-%20Management%20-%20Cookies).
